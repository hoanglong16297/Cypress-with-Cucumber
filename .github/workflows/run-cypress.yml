name: Run Cypress Tests

on:
  repository_dispatch:
    types:
      - run-cypress
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, linux, x64, general]
    container: node:18.16.0

    steps:
      - name: Trigger
        run: echo "Trigger success"

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          apt-get update
          apt-get -y install xvfb libgtk2.0-0 libgtk-3-0 libnotify-dev libgconf-2-4 libgbm-dev libnss3 libxss1 libasound2 libxtst6 xauth
          yarn install

      - name: Run Cypress Tests
        id: cypress-tests
        run: |
          echo "Running Yarn test"
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 >/dev/null 2>&1 &
          yarn test
          echo "OUTCOME=${{ job.status }}" >> $GITHUB_ENV

      - name: Check test results
        run: |
          if [[ "${{ env.TEST_RESULT }}" -eq 0 ]]; then
            echo "All specs passed"
          else
            echo "Some specs failed"
          fi

